import os
from cgtscons import *

# clone to avoid modifying parent enviroment
Import("env",)
env = env.Clone()
libAddSonLib(env)
libAddCuTest(env)
libAddKyotoDatabase(env)

##
# sonLib
##
slEnv = env.Clone()
slEnv.Append(CPPPATH=["lz4", "quicktree/include"])
quicktreeSrcs = [os.path.join("quicktree/src", f) for f in 
                 ["align.c", "cluster.c", "distancemat.c",
                  "distancemat_merops.c", "options.c", "sequence.c",
                  "tree.c", "buildtree.c", "util.c"]]
lz4Srcs = ["lz4/lz4.c", "lz4/lz4hc.c"]
threeEdgeSrcs = ["threeEdgeConnected/src/3_Absorb3edge2x.c"]
matchOrderSrcs = Glob("matchingAndOrdering/src/*.c")
pinchesSrcs = Glob("pinchesAndCacti/src/*.c")
sonLibSrcs = Glob("sonLib/src/*.c") + Glob("sonLib/src/*.cpp")
buildStaticLibrary(slEnv, SONLIB_LIB_NAME,
                   sonLibSrcs + quicktreeSrcs + lz4Srcs + threeEdgeSrcs + matchOrderSrcs + pinchesSrcs)

##
# cutest
##
cutestSrcs = ["cutest/CuTest.c", "cutest/CuTestTest.c"]
buildStaticLibrary(slEnv, CUTEST_LIB_NAME, cutestSrcs)

##
# sonLib tests
##
env = slEnv.Clone()

# these are compiled separately, exclude from glob of unit tests
# FIXME: would it be better to just list?
nonUnitTests = ["kt_connect_test.cpp", "cigarsTest.c", "fastaCTest.c",
                "kvDatabaseTest.c", "kvDatabaseTestCommon.c"]
testSrcDir = "sonLib/tests"
linkTestProg(env, "sonLib_Tests",
             globSrcPaths(env, testSrcDir, "*.c", excludes=nonUnitTests))
linkTestProg(env, "sonLib_cigarsTest",
             getSrcPaths(testSrcDir, ["cigarsTest.c"]))
linkTestProg(env, "sonLib_fastaCTest",
             getSrcPaths(testSrcDir, ["fastaCTest.c"]))
linkTestProg(env, "threeEdgeConnectedTests",
             globSrcPaths(env, "threeEdgeConnected/tests", "*.c"))

# need special flags for anything including kyoto typhoon, etc headers
slKtTestEnv = env.Clone()
slKtTestEnv.Append(CXXFLAGS=["-fpermissive", "-Wno-overflow", "-Wno-unused-but-set-variable",
                             "-Wno-conversion-null", "-Wno-narrowing"])
linkTestProg(slKtTestEnv, "sonLib_kt_connect_test",
             getSrcPaths(testSrcDir, ["kt_connect_test.cpp"]))
linkTestProg(slKtTestEnv, "sonLib_kvDatabaseTest",
             getSrcPaths(testSrcDir, ["kvDatabaseTest.c", "kvDatabaseTestCommon.c"]))

##
# blossom5 program
##
blEnv = env.Clone()
blEnv.Append(CXXFLAGS=["-fpermissive"])
linkProg(env, "blossum5",
         Glob("blossom/*.cpp") + Glob("blossom/GEOM/*.cpp") + Glob("blossom/MinCost/*.cpp"))


###
# python code
###
